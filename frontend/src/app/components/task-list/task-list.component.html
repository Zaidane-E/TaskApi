<div class="task-container">
  @if (isGuest()) {
    <div class="guest-banner">
      You're in guest mode. <a routerLink="/register">Register</a> to save your tasks permanently.
    </div>
  }

  @if (error()) {
    <div class="error">
      {{ error() }}
      <button class="btn-close" (click)="error.set(null)">x</button>
    </div>
  }

  <div class="add-task-form">
    <div class="form-row">
      <input
        type="text"
        class="title-input"
        placeholder="Enter a new task..."
        [ngModel]="newTaskTitle()"
        (ngModelChange)="newTaskTitle.set($event)"
        (keyup.enter)="addTask()"
      />
    </div>
    <div class="form-row">
      <select
        [ngModel]="newTaskPriority()"
        (ngModelChange)="newTaskPriority.set($event)"
      >
        @for (p of priorities; track p) {
          <option [value]="p">{{ p }}</option>
        }
      </select>
      <input
        type="date"
        [ngModel]="newTaskDueDate()"
        (ngModelChange)="newTaskDueDate.set($event)"
      />
      <button class="btn-primary" (click)="addTask()">Add Task</button>
    </div>
  </div>

  <div class="filters">
    <label>
      Status:
      <select
        [ngModel]="filterStatus()"
        (ngModelChange)="filterStatus.set($event); applyFilters()"
      >
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
      </select>
    </label>
    <label>
      Priority:
      <select
        [ngModel]="filterPriority()"
        (ngModelChange)="filterPriority.set($event); applyFilters()"
      >
        <option value="all">All</option>
        @for (p of priorities; track p) {
          <option [value]="p">{{ p }}</option>
        }
      </select>
    </label>
    <label>
      Sort:
      <select
        [ngModel]="sortBy()"
        (ngModelChange)="sortBy.set($event); applyFilters()"
      >
        <option value="createdAt">Created</option>
        <option value="dueDate">Due Date</option>
        <option value="priority">Priority</option>
      </select>
    </label>
    <label>
      Order:
      <select
        [ngModel]="sortOrder()"
        (ngModelChange)="sortOrder.set($event); applyFilters()"
      >
        <option value="desc">Newest</option>
        <option value="asc">Oldest</option>
      </select>
    </label>
  </div>

  @if (loading()) {
    <div class="loading">Loading tasks...</div>
  } @else {
    @if (tasks().length === 0) {
      <div class="empty">No tasks found. Add your first task above!</div>
    } @else {
      <ul class="task-list">
        @for (task of tasks(); track task.id) {
          <li class="task-item" [class.completed]="task.isCompleted" [class.overdue]="task.isOverdue">
            @if (editingTask()?.id === task.id) {
              <div class="edit-form">
                <input
                  type="text"
                  class="edit-title"
                  [ngModel]="editTitle()"
                  (ngModelChange)="editTitle.set($event)"
                  (keyup.enter)="saveEdit()"
                  (keyup.escape)="cancelEdit()"
                />
                <select
                  [ngModel]="editPriority()"
                  (ngModelChange)="editPriority.set($event)"
                >
                  @for (p of priorities; track p) {
                    <option [value]="p">{{ p }}</option>
                  }
                </select>
                <input
                  type="date"
                  [ngModel]="editDueDate()"
                  (ngModelChange)="editDueDate.set($event)"
                />
                <button class="btn-save" (click)="saveEdit()">Save</button>
                <button class="btn-cancel" (click)="cancelEdit()">Cancel</button>
              </div>
            } @else {
              <div class="task-content">
                <input
                  type="checkbox"
                  [checked]="task.isCompleted"
                  (change)="toggleComplete(task)"
                />
                <div class="task-info">
                  <span class="task-title">{{ task.title }}</span>
                  <div class="task-meta">
                    <span class="priority-badge" [class]="getPriorityClass(task.priority)">
                      {{ task.priority }}
                    </span>
                    @if (task.isOverdue) {
                      <span class="overdue-badge">Overdue</span>
                    }
                    @if (task.dueDate) {
                      <span class="due-date">Due: {{ formatDate(task.dueDate) }}</span>
                    }
                    @if (task.completedAt) {
                      <span class="completed-date">Completed: {{ formatDate(task.completedAt) }}</span>
                    }
                  </div>
                </div>
              </div>
              <div class="task-actions">
                <button class="btn-edit" (click)="startEdit(task)">Edit</button>
                <button class="btn-delete" (click)="deleteTask(task.id)">Delete</button>
              </div>
            }
          </li>
        }
      </ul>
    }
  }

  <div class="stats">
    <span>Total: <span class="count">{{ tasks().length }}</span></span>
    <span>Completed: <span class="count">{{ completedCount() }}</span></span>
    <span>Pending: <span class="count">{{ pendingCount() }}</span></span>
  </div>
</div>
