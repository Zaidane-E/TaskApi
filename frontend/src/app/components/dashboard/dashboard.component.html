<div class="dashboard-container">
  <div class="dashboard-header">
    <h1 class="dashboard-title">Dashboard</h1>
    <span class="datetime">{{ currentDateTime() }}</span>
  </div>

  <!-- Weekly Overview -->
  <div class="section week-section">
    <div class="section-header">
      <h2 class="section-title">This Week</h2>
    </div>
    <div class="week-grid">
      @for (day of weekDays(); track day.dateStr) {
        <div class="day-card" [class.today]="day.isToday" [class.future]="day.date > today">
          <div class="day-header">
            <span class="day-name">{{ day.dayName }}</span>
            <span class="day-num">{{ day.dayNum }}</span>
          </div>
          <div class="day-stats">
            <div class="stat-ring" [class]="getCompletionColor(day.habitCompletion)">
              <span class="ring-value">{{ day.habitCompletion }}%</span>
            </div>
            <div class="stat-details">
              <span class="stat-line habits">
                <span class="stat-icon">H</span>
                {{ day.habitsCompleted }}/{{ day.habitsTotal }}
              </span>
              <span class="stat-line tasks">
                <span class="stat-icon">T</span>
                {{ day.tasksCompleted }}
              </span>
            </div>
          </div>
        </div>
      }
    </div>
  </div>

  <div class="dashboard-grid">
    <!-- Today's Habits -->
    <div class="section habits-section">
      <div class="section-header">
        <h2 class="section-title">Today's Habits</h2>
        <a routerLink="/habits" class="section-link">View All</a>
      </div>
      <div class="progress-bar-mini">
        <div class="progress-fill-mini" [style.width.%]="habitsProgressPercent()"></div>
        <div class="goal-marker-mini" [style.left.%]="accountabilitySettings().goalPercentage"></div>
      </div>
      <div class="progress-stats">
        <span>{{ habitsCompletedToday() }}/{{ todaysHabits().length }} completed</span>
        <span class="goal-text" [class.met]="goalMet()" [class.missed]="!goalMet()">
          Goal: {{ accountabilitySettings().goalPercentage }}%
        </span>
      </div>
      <ul class="compact-list">
        @for (habit of todaysHabits(); track habit.id) {
          <li class="compact-item" [class.completed]="habit.isCompletedToday">
            <input
              type="checkbox"
              [checked]="habit.isCompletedToday"
              (change)="toggleHabit(habit)"
            />
            <span class="item-title">{{ habit.title }}</span>
            @if (habit.currentStreak > 0 && habit.isCompletedToday) {
              <span class="streak-badge">{{ habit.currentStreak }}x</span>
            }
          </li>
        }
        @if (todaysHabits().length === 0) {
          <li class="empty-item">No active habits</li>
        }
      </ul>
    </div>

    <!-- Pending Tasks -->
    <div class="section tasks-section">
      <div class="section-header">
        <h2 class="section-title">Pending Tasks</h2>
        <a routerLink="/tasks" class="section-link">View All</a>
      </div>
      <div class="task-summary">
        <span class="summary-item">
          <span class="summary-count pending">{{ totalPendingTasks() }}</span> pending
        </span>
        @if (totalOverdueTasks() > 0) {
          <span class="summary-item overdue">
            <span class="summary-count overdue">{{ totalOverdueTasks() }}</span> overdue
          </span>
        }
      </div>
      <ul class="compact-list">
        @for (task of todaysTasks(); track task.id) {
          <li class="compact-item" [class.completed]="task.isCompleted" [class.overdue]="task.isOverdue && !task.isCompleted">
            <input
              type="checkbox"
              [checked]="task.isCompleted"
              (change)="toggleTask(task)"
            />
            <span class="item-title">{{ task.title }}</span>
            @if (task.dueDate) {
              <span class="due-date-badge" [class.overdue]="task.isOverdue">{{ formatDate(task.dueDate) }}</span>
            }
            <span class="priority-dot" [class]="'priority-' + task.priority.toLowerCase()"></span>
          </li>
        }
        @if (todaysTasks().length === 0) {
          <li class="empty-item">No pending tasks</li>
        }
      </ul>
    </div>

    <!-- Accountability Status -->
    <div class="section accountability-section">
      <div class="section-header">
        <h2 class="section-title">Accountability</h2>
        <a routerLink="/habits/accountability" class="section-link">Manage</a>
      </div>
      <div class="accountability-status" [class.goal-met]="goalMet()" [class.goal-missed]="!goalMet()">
        <div class="status-indicator">
          <span class="status-icon">{{ goalMet() ? 'Y' : 'X' }}</span>
          <span class="status-text">{{ goalMet() ? 'Goal Met!' : 'Goal Not Met' }}</span>
        </div>
        <div class="status-progress">
          <span class="current-rate">{{ habitsProgressPercent() }}%</span>
          <span class="target-rate">/ {{ accountabilitySettings().goalPercentage }}%</span>
        </div>
      </div>

      <div class="accountability-actions">
        <!-- Penalties (when goal not met) -->
        @if (!goalMet() && accountabilitySettings().penalties.length > 0) {
          <div class="action-panel penalty">
            <div class="panel-header">
              <span class="panel-label">Penalties</span>
              @if (todayLog()?.penaltyApplied) {
                <div class="status-hover-wrapper">
                  <span class="action-status applied">Applied</span>
                  <button class="btn-undo-small penalty" (click)="cancelPenalty()">Undo</button>
                </div>
              } @else if (accountabilitySettings().penalties.length > 1) {
                <button class="btn-random" (click)="pickRandomPenalty()">Random</button>
              }
            </div>
            <ul class="action-list">
              @for (penalty of accountabilitySettings().penalties; track penalty.id) {
                <li class="action-item"
                    [class.selected]="selectedPenalty()?.id === penalty.id"
                    [class.applied]="todayLog()?.penaltyApplied && todayLog()?.appliedPenaltyId === penalty.id">
                  <span class="action-text">{{ penalty.description }}</span>
                  @if (!todayLog()?.penaltyApplied) {
                    <button class="btn-apply" (click)="applyPenalty(penalty.id)">Apply</button>
                  } @else if (todayLog()?.appliedPenaltyId === penalty.id) {
                    <div class="badge-hover-wrapper">
                      <span class="applied-badge">Applied</span>
                      <button class="btn-undo-tiny penalty" (click)="cancelPenalty()">Undo</button>
                    </div>
                  }
                </li>
              }
            </ul>
          </div>
        }

        <!-- Rewards (when goal met) -->
        @if (goalMet() && accountabilitySettings().rewards.length > 0) {
          <div class="action-panel reward">
            <div class="panel-header">
              <span class="panel-label">Rewards</span>
              @if (todayLog()?.rewardClaimed) {
                <div class="status-hover-wrapper">
                  <span class="action-status claimed">Claimed</span>
                  <button class="btn-undo-small reward" (click)="cancelReward()">Undo</button>
                </div>
              } @else if (accountabilitySettings().rewards.length > 1) {
                <button class="btn-random" (click)="pickRandomReward()">Random</button>
              }
            </div>
            <ul class="action-list">
              @for (reward of accountabilitySettings().rewards; track reward.id) {
                <li class="action-item"
                    [class.selected]="selectedReward()?.id === reward.id"
                    [class.claimed]="todayLog()?.rewardClaimed && todayLog()?.claimedRewardId === reward.id">
                  <span class="action-text">{{ reward.description }}</span>
                  @if (!todayLog()?.rewardClaimed) {
                    <button class="btn-claim" (click)="claimReward(reward.id)">Claim</button>
                  } @else if (todayLog()?.claimedRewardId === reward.id) {
                    <div class="badge-hover-wrapper">
                      <span class="claimed-badge">Claimed</span>
                      <button class="btn-undo-tiny reward" (click)="cancelReward()">Undo</button>
                    </div>
                  }
                </li>
              }
            </ul>
          </div>
        }

        <!-- No penalties/rewards configured -->
        @if ((!goalMet() && accountabilitySettings().penalties.length === 0) ||
             (goalMet() && accountabilitySettings().rewards.length === 0)) {
          <div class="empty-actions">
            <span>No {{ goalMet() ? 'rewards' : 'penalties' }} set up yet.</span>
            <a routerLink="/habits/accountability">Configure</a>
          </div>
        }
      </div>
    </div>
  </div>
</div>
