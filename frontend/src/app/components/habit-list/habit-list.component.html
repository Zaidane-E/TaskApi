<div class="habit-container">
  @if (error()) {
    <div class="error">
      {{ error() }}
      <button class="btn-close" (click)="error.set(null)">x</button>
    </div>
  }

  <div class="nav-tabs">
    <a routerLink="/habits" class="tab-link active">Habits</a>
    <a routerLink="/habits/overview" class="tab-link">Overview</a>
    <a routerLink="/habits/accountability" class="tab-link">Accountability</a>
  </div>

  <!-- Daily Progress Bar -->
  <div class="progress-section">
    <div class="progress-header">
      <span class="progress-label">TODAY'S PROGRESS</span>
      <span class="progress-text">{{ completedTodayCount() }} / {{ totalActiveCount() }}</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="progressPercent()"></div>
      <div class="goal-marker" [style.left.%]="goalPercentage()"></div>
    </div>
    <div class="progress-percent">{{ progressPercent() }}%</div>
  </div>

  <div class="add-habit-form">
    <div class="form-row">
      <input
        type="text"
        class="title-input"
        placeholder="Enter a new daily habit..."
        [ngModel]="newHabitTitle()"
        (ngModelChange)="newHabitTitle.set($event)"
        (keyup.enter)="addHabit()"
      />
      <button class="btn-primary" (click)="addHabit()">Add Habit</button>
    </div>
  </div>

  <div class="filters">
    <label>
      Sort by:
      <select
        [ngModel]="sortBy()"
        (ngModelChange)="sortBy.set($event); applySort()"
      >
        <option value="default">Default</option>
        <option value="completionRate">Completion Rate</option>
        <option value="streak">Streak</option>
        <option value="completionStatus">Completion Status</option>
      </select>
    </label>
    @if (sortBy() !== 'default') {
      <button class="btn-sort-direction" (click)="toggleSortDirection()">
        {{ sortAscending() ? '↑ ASC' : '↓ DESC' }}
      </button>
    }
  </div>

  @if (loading()) {
    <div class="loading">Loading habits...</div>
  } @else {
    @if (habits().length === 0) {
      <div class="empty">No habits found. Add your first habit above!</div>
    } @else {
      <ul class="habit-list">
        @for (habit of habits(); track habit.id) {
          <li class="habit-item"
              [class.completed]="habit.isCompletedToday">
            @if (editingHabit()?.id === habit.id) {
              <div class="edit-form">
                <input
                  type="text"
                  class="edit-title"
                  [ngModel]="editTitle()"
                  (ngModelChange)="editTitle.set($event)"
                  (keyup.enter)="saveEdit()"
                  (keyup.escape)="cancelEdit()"
                />
                <button class="btn-save" (click)="saveEdit()">Save</button>
                <button class="btn-cancel" (click)="cancelEdit()">Cancel</button>
              </div>
            } @else {
              <div class="habit-content">
                <input
                  type="checkbox"
                  [checked]="habit.isCompletedToday"
                  (change)="toggleComplete(habit)"
                />
                <div class="habit-info">
                  <span class="habit-title">{{ habit.title }}</span>
                </div>
                <div class="habit-stats">
                  @if (habit.isCompletedToday && habit.currentStreak > 0) {
                    <div class="streak-tooltip">
                      <span class="streak-indicator">{{ habit.currentStreak }}x</span>
                      <div class="tooltip-content">Current streak</div>
                    </div>
                  }
                  <div class="habit-tooltip">
                    <span class="completion-rate">{{ habit.completionRate }}%</span>
                    <div class="tooltip-content">All-time completion rate</div>
                  </div>
                </div>
              </div>
              <div class="habit-actions">
                <button class="btn-edit" (click)="startEdit(habit)">Edit</button>
                <button class="btn-delete" (click)="deleteHabit(habit.id)">Delete</button>
              </div>
            }
          </li>
        }
      </ul>
    }
  }

  <div class="stats">
    <span class="datetime">{{ currentDateTime() }}</span>
    <span>Active: <span class="count">{{ totalActiveCount() }}</span></span>
    <span>Completed: <span class="count completed">{{ completedTodayCount() }}</span></span>
    <span>Pending: <span class="count pending">{{ pendingCount() }}</span></span>
  </div>
</div>
